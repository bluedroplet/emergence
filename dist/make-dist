#!/bin/bash -v

cd ../em-tools
make distclean
aclocal-1.8 || exit
automake-1.8 || exit
autoconf-2.59 || exit

cd ../em-game
make distclean
aclocal-1.8 || exit
automake-1.8 || exit
autoconf-2.59 || exit

cd ../em-tools

./configure || exit

make distcheck || exit

cp em-tools-0.5.3-dev.tar.bz2 ../dist/em-tools-0.5.3-dev.tbz2

cd ../dist


for arch in pentiumpro pentium2 pentium3 pentium4 athlon athlon-tbird athlon-xp athlon-mp
#for arch in pentium4
do

stage3=i686

if  [ $arch == pentium3  -o  $arch == pentium4  -o $arch == athlon-xp ] 
	then stage3=$arch
fi

echo Building Emergence for $arch

export CFLAGS="-march=$arch -O3 -pipe -fomit-frame-pointer"
ln -sfn stage3-$stage3-2004.1 ../../stage3s/current-stage3 || exit


rm -rf root
mkdir -p root/usr

cd ../em-game
make clean

D=`pwd`/../dist/root/

./configure --prefix=/usr || exit
make || exit
make prefix=${D}/usr \
		    datadir=${D}/usr/share \
		    infodir=${D}/usr/share/info \
		    localstatedir=${D}/var/lib \
		    mandir=${D}/usr/share/man \
		    sysconfdir=${D}/etc \
		    install || exit

cd ../dist/root

strip usr/bin/* || exit
tar --owner=0 --group=0 --numeric-owner -cjf ../em-game-0.5.3-dev.bin.$arch.tbz2 * || exit
cd ..


#cd ../em-tools
#make clean
#
#./configure --prefix=/usr || exit
#make || exit
#make prefix=${D}/usr \
#		    datadir=${D}/usr/share \
#		    infodir=${D}/usr/share/info \
#		    localstatedir=${D}/var/lib \
#		    mandir=${D}/usr/share/man \
#		    sysconfdir=${D}/etc \
#		    install || exit


cd ../dist/root

strip usr/bin/* || exit

tar --owner=0 --group=0 --numeric-owner -cjf ../emergence-0.5.3-dev.bin.$arch.tbz2 * || exit

find * -type f -printf "/%h/%f\n">../tree

cd ..



rpmbuild -bb emergence.spec

cp ../../redhat/emergence/i386/emergence-0.5.3-dev-1.i386.rpm emergence-0.5.3-dev.$arch.rpm


done
